/************************************************************************
 
 The contents of this file are subject to the Mozilla Public License
 Version 1.1 (the "License"); you may not use this file except in
 compliance with the License. You may obtain a copy of the License at
 http://www.mozilla.org/MPL/
 
 Software distributed under the License is distributed on an "AS IS"
 basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
 License for the specific language governing rights and limitations
 under the License.
 
 The Original Code is Isearch.
 
 The Initial Developer of the Original Code is Clearinghouse for
 Networked Information Discovery and Retrieval.
 
 Portions created by Netscape Communications are Copyright (C) 2001-2002.
 All Rights Reserved.
 
 Portions created by the Clearinghouse for Networked Information
 Discovery and Retrieval are Copyright (C) 1994. All Rights Reserved.
 
************************************************************************/

/*
 * utf8.c  - UTF-8 support functions.
 * 
 * Authors: Bob Truel & Bryn Dole
 *
 */

#include <stdio.h>
#include <string.h>
#include "gdt.h"

typedef struct s_master_entry {
    unsigned int begin;
    int subtract;
    unsigned int *conv_table;
} m_entry;

unsigned int T_00C0[372] = {
0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 	/* 00c0: a a a a a a */
0x00E6, 0x0063, 0x0065, 0x0065, 0x0065, 0x0065, 	/* 00c6: æ c e e e e */
0x0069, 0x0069, 0x0069, 0x0069, 0x00F0, 0x006E, 	/* 00cc: i i i i ð n */
0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 0x00D7, 	/* 00d2: o o o o o × */
0x006F, 0x0075, 0x0075, 0x0075, 0x0075, 0x0079, 	/* 00d8: o u u u u y */
0x00FE, 0x00DF, 0x0061, 0x0061, 0x0061, 0x0061, 	/* 00de: þ ß a a a a */
0x0061, 0x0061, 0x00E6, 0x0063, 0x0065, 0x0065, 	/* 00e4: a a æ c e e */
0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069, 	/* 00ea: e e i i i i */
0x00F0, 0x006E, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 00f0: ð n o o o o */
0x006F, 0x00F7, 0x006F, 0x0075, 0x0075, 0x0075, 	/* 00f6: o ÷ o u u u */
0x0075, 0x0079, 0x00FE, 0x0079, 0x0061, 0x0061, 	/* 00fc: u y þ y a a */
0x0061, 0x0061, 0x0061, 0x0061, 0x0063, 0x0063, 	/* 0102: a a a a c c */
0x0063, 0x0063, 0x0063, 0x0063, 0x0063, 0x0063, 	/* 0108: c c c c c c */
0x0064, 0x0064, 0x0064, 0x0064, 0x0065, 0x0065, 	/* 010e: d d d d e e */
0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 	/* 0114: e e e e e e */
0x0065, 0x0065, 0x0067, 0x0067, 0x0067, 0x0067, 	/* 011a: e e g g g g */
0x0067, 0x0067, 0x0067, 0x0067, 0x0068, 0x0068, 	/* 0120: g g g g h h */
0x0068, 0x0068, 0x0069, 0x0069, 0x0069, 0x0069, 	/* 0126: h h i i i i */
0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 	/* 012c: i i i i i i */
0x0133, 0x0133, 0x006A, 0x006A, 0x006B, 0x006B, 	/* 0132: . = j j k k */
0x0138, 0x006C, 0x006C, 0x006C, 0x006C, 0x006C, 	/* 0138: = l l l l l */
0x006C, 0x006C, 0x006C, 0x006C, 0x006C, 0x006E, 	/* 013e: l l l l l n */
0x006E, 0x006E, 0x006E, 0x006E, 0x006E, 0x0149, 	/* 0144: n n n n n = */
0x014B, 0x014B, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 014a: = = o o o o */
0x006F, 0x006F, 0x0153, 0x0153, 0x0072, 0x0072, 	/* 0150: o o . = r r */
0x0072, 0x0072, 0x0072, 0x0072, 0x0073, 0x0073, 	/* 0156: r r r r s s */
0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 	/* 015c: s s s s s s */
0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 	/* 0162: t t t t t t */
0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 	/* 0168: u u u u u u */
0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 	/* 016e: u u u u u u */
0x0077, 0x0077, 0x0079, 0x0079, 0x0079, 0x007A, 	/* 0174: w w y y y z */
0x007A, 0x007A, 0x007A, 0x007A, 0x007A, 0x017F, 	/* 017a: z z z z z = */
0x0062, 0x0062, 0x0062, 0x0062, 0x0185, 0x0185, 	/* 0180: b b b b . = */
0x0254, 0x0063, 0x0063, 0x0256, 0x0064, 0x0064, 	/* 0186: . c c . d d */
0x0064, 0x018D, 0x0258, 0x0259, 0x025B, 0x0066, 	/* 018c: d = . . . f */
0x0066, 0x0067, 0x0263, 0x0195, 0x0269, 0x0069, 	/* 0192: f g . = . i */
0x006B, 0x006B, 0x006C, 0x019B, 0x026F, 0x006E, 	/* 0198: k k l = . n */
0x006E, 0x006F, 0x006F, 0x006F, 0x01A3, 0x01A3, 	/* 019e: n o o o = = */
0x0070, 0x0070, 0x0280, 0x01A8, 0x01A8, 0x0283, 	/* 01a4: p p . = = . */
0x01AA, 0x0074, 0x0074, 0x0074, 0x0074, 0x0075, 	/* 01aa: = t t t t u */
0x0075, 0x028A, 0x0076, 0x0079, 0x0079, 0x007A, 	/* 01b0: u . v y y z */
0x007A, 0x0292, 0x01B9, 0x01B9, 0x0292, 0x01BB, 	/* 01b6: z . = = . = */
0x01BD, 0x01BD, 0x01BE, 0x01BF, 0x01C0, 0x01C1, 	/* 01bc: = = = = = = */
0x01C2, 0x01C3, 0x01F3, 0x01C6, 0x01F3, 0x01C9, 	/* 01c2: = = = = = = */
0x01C9, 0x01C9, 0x01CC, 0x01CC, 0x01CC, 0x0061, 	/* 01c8: = = = = = a */
0x0061, 0x0069, 0x0069, 0x006F, 0x006F, 0x0075, 	/* 01ce: a i i o o u */
0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 	/* 01d4: u u u u u u */
0x0075, 0x0075, 0x0075, 0x01DD, 0x0061, 0x0061, 	/* 01da: u u u = a a */
0x0061, 0x0061, 0x00E6, 0x00E6, 0x0067, 0x0067, 	/* 01e0: a a æ æ g g */
0x0067, 0x0067, 0x006B, 0x006B, 0x006F, 0x006F, 	/* 01e6: g g k k o o */
0x006F, 0x006F, 0x0292, 0x0292, 0x006A, 0x01F3, 	/* 01ec: o o . . j = */
0x01F3, 0x01F3, 0x0067, 0x0067, 0x0195, 0x01BF, 	/* 01f2: = = g g . = */
0x006E, 0x006E, 0x0061, 0x0061, 0x00E6, 0x00E6, 	/* 01f8: n n a a æ æ */
0x006F, 0x006F, 0x0061, 0x0061, 0x0061, 0x0061, 	/* 01fe: o o a a a a */
0x0065, 0x0065, 0x0065, 0x0065, 0x0069, 0x0069, 	/* 0204: e e e e i i */
0x0069, 0x0069, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 020a: i i o o o o */
0x0072, 0x0072, 0x0072, 0x0072, 0x0075, 0x0075, 	/* 0210: r r r r u u */
0x0075, 0x0075, 0x0073, 0x0073, 0x0074, 0x0074, 	/* 0216: u u s s t t */
0x021D, 0x021D, 0x0068, 0x0068, 0x0220, 0x0221, 	/* 021c: = = h h = = */
0x0223, 0x0223, 0x007A, 0x007A, 0x0061, 0x0061, 	/* 0222: . = z z a a */
0x0065, 0x0065, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 0228: e e o o o o */
0x006F, 0x006F, 0x006F, 0x006F, 0x0079, 0x0079, 	/* 022e: o o o o y y */
};

unsigned int T_0386[372] = {
0x03B1, 0x0387, 0x03B5, 0x03B7, 0x03B9, 0x038B, 	/* 0386: . = . . . = */
0x03BF, 0x038D, 0x03C5, 0x03C9, 0x03B9, 0x03B1, 	/* 038c: . = . . . . */
0x03B2, 0x03B3, 0x03B4, 0x03B5, 0x03B6, 0x03B7, 	/* 0392: . . . . . . */
0x03B8, 0x03B9, 0x03BA, 0x03BB, 0x03BC, 0x03BD, 	/* 0398: . . . . . . */
0x03BE, 0x03BF, 0x03C0, 0x03C1, 0x03A2, 0x03C3, 	/* 039e: . . = = = = */
0x03C4, 0x03C5, 0x03C6, 0x03C7, 0x03C8, 0x03C9, 	/* 03a4: = = = = = = */
0x03B9, 0x03C5, 0x03B1, 0x03B5, 0x03B7, 0x03B9, 	/* 03aa: = = = = = = */
0x03C5, 0x03B1, 0x03B2, 0x03B3, 0x03B4, 0x03B5, 	/* 03b0: = = = = = = */
0x03B6, 0x03B7, 0x03B8, 0x03B9, 0x03BA, 0x03BB, 	/* 03b6: = = = = = = */
0x03BC, 0x03BD, 0x03BE, 0x03BF, 0x03C0, 0x03C1, 	/* 03bc: = = = = = = */
0x03C2, 0x03C3, 0x03C4, 0x03C5, 0x03C6, 0x03C7, 	/* 03c2: = = = = = = */
0x03C8, 0x03C9, 0x03B9, 0x03C5, 0x03BF, 0x03C5, 	/* 03c8: = = = = = = */
0x03C9, 0x03CF, 0x03B2, 0x03B8, 0x03D2, 0x03D3, 	/* 03ce: = = = = = = */
0x03D4, 0x03C6, 0x03C0, 0x03D7, 0x03D8, 0x03D9, 	/* 03d4: = = = = = = */
0x03DB, 0x03DB, 0x03DD, 0x03DD, 0x03DF, 0x03DF, 	/* 03da: = = = = = = */
0x03E1, 0x03E1, 0x03E3, 0x03E3, 0x03E5, 0x03E5, 	/* 03e0: . = . = . = */
0x03E7, 0x03E7, 0x03E9, 0x03E9, 0x03EB, 0x03EB, 	/* 03e6: . = . = = = */
0x03ED, 0x03ED, 0x03EF, 0x03EF, 0x03BA, 0x03C1, 	/* 03ec: = = = = = = */
0x03C3, 0x03F3, 0x03F4, 0x03F5, 0x03F6, 0x03F7, 	/* 03f2: = = = = = = */
0x03F8, 0x03F9, 0x03FA, 0x03FB, 0x03FC, 0x03FD, 	/* 03f8: = = = = = = */
0x03FE, 0x03FF, 0x0435, 0x0451, 0x0452, 0x0453, 	/* 03fe: = = . . . . */
0x0454, 0x0455, 0x0456, 0x0457, 0x0458, 0x0459, 	/* 0404: . . . . . . */
0x045A, 0x045B, 0x045C, 0x0438, 0x045E, 0x045F, 	/* 040a: . . . . . . */
0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 	/* 0410: . . . . . . */
0x0436, 0x0437, 0x0438, 0x0439, 0x043A, 0x043B, 	/* 0416: . . . . . . */
0x043C, 0x043D, 0x043E, 0x043F, 0x0440, 0x0441, 	/* 041c: . . . . . . */
0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447, 	/* 0422: . . . . . . */
0x0448, 0x0449, 0x044A, 0x044B, 0x044C, 0x044D, 	/* 0428: . . . . . . */
0x044E, 0x044F, 0x0430, 0x0431, 0x0432, 0x0433, 	/* 042e: . . = = = = */
0x0434, 0x0435, 0x0436, 0x0437, 0x0438, 0x0439, 	/* 0434: = = = = = = */
0x043A, 0x043B, 0x043C, 0x043D, 0x043E, 0x043F, 	/* 043a: = = = = = = */
0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 	/* 0440: = = = = = = */
0x0446, 0x0447, 0x0448, 0x0449, 0x044A, 0x044B, 	/* 0446: = = = = = = */
0x044C, 0x044D, 0x044E, 0x044F, 0x0435, 0x0451, 	/* 044c: = = = = . = */
0x0452, 0x0453, 0x0454, 0x0455, 0x0456, 0x0457, 	/* 0452: = = = = = = */
0x0458, 0x0459, 0x045A, 0x045B, 0x045C, 0x0438, 	/* 0458: = = = = = . */
0x045E, 0x045F, 0x0461, 0x0461, 0x0463, 0x0463, 	/* 045e: = = . = . = */
0x0465, 0x0465, 0x0467, 0x0467, 0x0469, 0x0469, 	/* 0464: . = . = . = */
0x046B, 0x046B, 0x046D, 0x046D, 0x046F, 0x046F, 	/* 046a: = = = = = = */
0x0471, 0x0471, 0x0473, 0x0473, 0x0475, 0x0475, 	/* 0470: . = . = . = */
0x0475, 0x0475, 0x0479, 0x0479, 0x047B, 0x047B, 	/* 0476: . . . = = = */
0x0461, 0x0461, 0x047F, 0x047F, 0x0481, 0x0481, 	/* 047c: . . = = . = */
0x0482, 0x0483, 0x0484, 0x0485, 0x0486, 0x0487, 	/* 0482: = = = = = = */
0x0488, 0x0489, 0x048A, 0x048B, 0x048D, 0x048D, 	/* 0488: = = = = = = */
0x0440, 0x0440, 0x0433, 0x0433, 0x0433, 0x0433, 	/* 048e: . . . . . . */
0x0433, 0x0433, 0x0436, 0x0436, 0x0437, 0x0437, 	/* 0494: . . . . . . */
0x043A, 0x043A, 0x043A, 0x043A, 0x043A, 0x043A, 	/* 049a: . . . . . . */
0x04A1, 0x04A1, 0x043D, 0x043D, 0x04A5, 0x04A5, 	/* 04a0: = = . . = = */
0x043F, 0x043F, 0x04A9, 0x04A9, 0x0441, 0x0441, 	/* 04a6: . . = = . . */
0x0442, 0x0442, 0x04AF, 0x04AF, 0x04AF, 0x04AF, 	/* 04ac: . . = = = = */
0x0445, 0x0445, 0x04B5, 0x04B5, 0x0447, 0x0447, 	/* 04b2: . . = = . . */
0x0447, 0x0447, 0x04BB, 0x04BB, 0x04BD, 0x04BD, 	/* 04b8: . . = = = = */
0x04BD, 0x04BD, 0x04C0, 0x0436, 0x0436, 0x043A, 	/* 04be: = = = . . . */
0x043A, 0x04C5, 0x04C6, 0x043D, 0x043D, 0x04C9, 	/* 04c4: . = = . . = */
0x04CA, 0x04CC, 0x04CC, 0x04CD, 0x04CE, 0x04CF, 	/* 04ca: = = = = = = */
0x0430, 0x0430, 0x0430, 0x0430, 0x04D5, 0x04D5, 	/* 04d0: . . . . = = */
0x0435, 0x0435, 0x04D9, 0x04D9, 0x04D9, 0x04D9, 	/* 04d6: . . = = = = */
0x0436, 0x0436, 0x0437, 0x0437, 0x04E1, 0x04E1, 	/* 04dc: . . . . . = */
0x0438, 0x0438, 0x0438, 0x0438, 0x043E, 0x043E, 	/* 04e2: . . . . . . */
0x04E9, 0x04E9, 0x04E9, 0x04E9, 0x044D, 0x044D, 	/* 04e8: . = . . . . */
0x0443, 0x0443, 0x0443, 0x0443, 0x0443, 0x0443, 	/* 04ee: . . . . . . */
0x0447, 0x0447, 0x04F6, 0x04F7, 0x044B, 0x044B, 	/* 04f4: . . = = . . */
};

unsigned int T_1E00[250] = {
0x0061, 0x0061, 0x0062, 0x0062, 0x0062, 0x0062, 	/* 1e00: a a b b b b */
0x0062, 0x0062, 0x0063, 0x0063, 0x0064, 0x0064, 	/* 1e06: b b c c d d */
0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 	/* 1e0c: d d d d d d */
0x0064, 0x0064, 0x0065, 0x0065, 0x0065, 0x0065, 	/* 1e12: d d e e e e */
0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 	/* 1e18: e e e e e e */
0x0066, 0x0066, 0x0067, 0x0067, 0x0068, 0x0068, 	/* 1e1e: f f g g h h */
0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 	/* 1e24: h h h h h h */
0x0068, 0x0068, 0x0069, 0x0069, 0x0069, 0x0069, 	/* 1e2a: h h i i i i */
0x006B, 0x006B, 0x006B, 0x006B, 0x006B, 0x006B, 	/* 1e30: k k k k k k */
0x006C, 0x006C, 0x006C, 0x006C, 0x006C, 0x006C, 	/* 1e36: l l l l l l */
0x006C, 0x006C, 0x006D, 0x006D, 0x006D, 0x006D, 	/* 1e3c: l l m m m m */
0x006D, 0x006D, 0x006E, 0x006E, 0x006E, 0x006E, 	/* 1e42: m m n n n n */
0x006E, 0x006E, 0x006E, 0x006E, 0x006F, 0x006F, 	/* 1e48: n n n n o o */
0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 1e4e: o o o o o o */
0x0070, 0x0070, 0x0070, 0x0070, 0x0072, 0x0072, 	/* 1e54: p p p p r r */
0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 	/* 1e5a: r r r r r r */
0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 	/* 1e60: s s s s s s */
0x0073, 0x0073, 0x0073, 0x0073, 0x0074, 0x0074, 	/* 1e66: s s s s t t */
0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 	/* 1e6c: t t t t t t */
0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 	/* 1e72: u u u u u u */
0x0075, 0x0075, 0x0075, 0x0075, 0x0076, 0x0076, 	/* 1e78: u u u u v v */
0x0076, 0x0076, 0x0077, 0x0077, 0x0077, 0x0077, 	/* 1e7e: v v w w w w */
0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 	/* 1e84: w w w w w w */
0x0078, 0x0078, 0x0078, 0x0078, 0x0079, 0x0079, 	/* 1e8a: x x x x y y */
0x007A, 0x007A, 0x007A, 0x007A, 0x007A, 0x007A, 	/* 1e90: z z z z z z */
0x0068, 0x0074, 0x0077, 0x0079, 0x0061, 0x017F, 	/* 1e96: h t w y a . */
0x1E9C, 0x1E9D, 0x1E9E, 0x1E9F, 0x0061, 0x0061, 	/* 1e9c: = = = = a a */
0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 	/* 1ea2: a a a a a a */
0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 	/* 1ea8: a a a a a a */
0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 	/* 1eae: a a a a a a */
0x0061, 0x0061, 0x0061, 0x0061, 0x0065, 0x0065, 	/* 1eb4: a a a a e e */
0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 	/* 1eba: e e e e e e */
0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 	/* 1ec0: e e e e e e */
0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069, 	/* 1ec6: e e i i i i */
0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 1ecc: o o o o o o */
0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 1ed2: o o o o o o */
0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 1ed8: o o o o o o */
0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 0x006F, 	/* 1ede: o o o o o o */
0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 	/* 1ee4: u u u u u u */
0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 	/* 1eea: u u u u u u */
0x0075, 0x0075, 0x0079, 0x0079, 0x0079, 0x0079, 	/* 1ef0: u u y y y y */
0x0079, 0x0079, 0x0079, 0x0079, };	                /* 1ef6: y y y y  */

unsigned int T_1F00[253] = {
0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1f00: . . . . . . */
0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1f06: . . . . . . */
0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B5, 0x03B5, 	/* 1f0c: . . . . . . */
0x03B5, 0x03B5, 0x03B5, 0x03B5, 0x1F16, 0x1F17, 	/* 1f12: . . . . = = */
0x03B5, 0x03B5, 0x03B5, 0x03B5, 0x03B5, 0x03B5, 	/* 1f18: . . . . . . */
0x1F1E, 0x1F1F, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 	/* 1f1e: = = . . . . */
0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 	/* 1f24: . . . . . . */
0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 	/* 1f2a: . . . . . . */
0x03B9, 0x03B9, 0x03B9, 0x03B9, 0x03B9, 0x03B9, 	/* 1f30: . . . . . . */
0x03B9, 0x03B9, 0x03B9, 0x03B9, 0x03B9, 0x03B9, 	/* 1f36: . . . . . . */
0x03B9, 0x03B9, 0x03B9, 0x03B9, 0x03BF, 0x03BF, 	/* 1f3c: . . . . . . */
0x03BF, 0x03BF, 0x03BF, 0x03BF, 0x1F46, 0x1F47, 	/* 1f42: . . . . = = */
0x03BF, 0x03BF, 0x03BF, 0x03BF, 0x03BF, 0x03BF, 	/* 1f48: . . . . . . */
0x1F4E, 0x1F4F, 0x03C5, 0x03C5, 0x03C5, 0x03C5, 	/* 1f4e: = = . . . . */
0x03C5, 0x03C5, 0x03C5, 0x03C5, 0x1F58, 0x03C5, 	/* 1f54: . . . . = . */
0x1F5A, 0x03C5, 0x1F5C, 0x03C5, 0x1F5E, 0x03C5, 	/* 1f5a: = . = . = . */
0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 	/* 1f60: . . . . . . */
0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 	/* 1f66: . . . . . . */
0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03B1, 0x03B1, 	/* 1f6c: . . . . . . */
0x03B5, 0x03B5, 0x03B7, 0x03B7, 0x03B9, 0x03B9, 	/* 1f72: . . . . . . */
0x03BF, 0x03BF, 0x03C5, 0x03C5, 0x03C9, 0x03C9, 	/* 1f78: . . . . . . */
0x1F7E, 0x1F7F, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1f7e: = = . . . . */
0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1f84: . . . . . . */
0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1f8a: . . . . . . */
0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 	/* 1f90: . . . . . . */
0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03B7, 	/* 1f96: . . . . . . */
0x03B7, 0x03B7, 0x03B7, 0x03B7, 0x03C9, 0x03C9, 	/* 1f9c: . . . . . . */
0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 	/* 1fa2: . . . . . . */
0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 0x03C9, 	/* 1fa8: . . . . . . */
0x03C9, 0x03C9, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1fae: . . . . . . */
0x03B1, 0x1FB5, 0x03B1, 0x03B1, 0x03B1, 0x03B1, 	/* 1fb4: . = . . . . */
0x03B1, 0x03B1, 0x03B1, 0x1FBD, 0x03B9, 0x1FBF, 	/* 1fba: . . . = . = */
0x1FC0, 0x1FC1, 0x03B7, 0x03B7, 0x03B7, 0x1FC5, 	/* 1fc0: = = . . . = */
0x03B7, 0x03B7, 0x03B5, 0x03B5, 0x03B7, 0x03B7, 	/* 1fc6: . . . . . . */
0x03B7, 0x1FCD, 0x1FCE, 0x1FCF, 0x03B9, 0x03B9, 	/* 1fcc: . = = = . . */
0x03B9, 0x03B9, 0x1FD4, 0x1FD5, 0x03B9, 0x03B9, 	/* 1fd2: . . = = . . */
0x03B9, 0x03B9, 0x03B9, 0x03B9, 0x1FDC, 0x1FDD, 	/* 1fd8: . . . . = = */
0x1FDE, 0x1FDF, 0x03C5, 0x03C5, 0x03C5, 0x03C5, 	/* 1fde: = = . . . . */
0x03C1, 0x03C1, 0x03C5, 0x03C5, 0x03C5, 0x03C5, 	/* 1fe4: . . . . . . */
0x03C5, 0x03C5, 0x03C1, 0x1FED, 0x1FEE, 0x1FEF, 	/* 1fea: . . . = = = */
0x1FF0, 0x1FF1, 0x03C9, 0x03C9, 0x03C9, 0x1FF5, 	/* 1ff0: = = . . . = */
0x03C9, 0x03C9, 0x03BF, 0x03BF, 0x03C9, 0x03C9, 	/* 1ff6: . . . . . . */
0x03C9, };	                                        /* 1ffc: .  */

unsigned int T_FF21[58] = {
0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 	/* ff21: a b c d e f */
0x0067, 0x0068, 0x0069, 0x006A, 0x006B, 0x006C, 	/* ff27: g h i j k l */
0x006D, 0x006E, 0x006F, 0x0070, 0x0071, 0x0072, 	/* ff2d: m n o p q r */
0x0073, 0x0074, 0x0075, 0x0076, 0x0077, 0x0078, 	/* ff33: s t u v w x */
0x0079, 0x007A, 0xFF3B, 0xFF3C, 0xFF3D, 0xFF3E, 	/* ff39: y z = = = = */
0xFF3F, 0xFF40, 0x0061, 0x0062, 0x0063, 0x0064, 	/* ff3f: = = a b c d */
0x0065, 0x0066, 0x0067, 0x0068, 0x0069, 0x006A, 	/* ff45: e f g h i j */
0x006B, 0x006C, 0x006D, 0x006E, 0x006F, 0x0070, 	/* ff4b: k l m n o p */
0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 	/* ff51: q r s t u v */
0x0077, 0x0078, 0x0079, 0x007A, };	                /* ff57: w x y z  */

m_entry master_table[] = {
	{ 0x0000,      0, 0 },
	{ 0x0041,  -0x20, 0 },
	{ 0x005B,      0, 0 },
	{ 0x00C0, 0x00C0, T_00C0 },
	{ 0x0233,      0, 0 },
	{ 0x0386, 0x0386, T_0386 },
	{ 0x04F9,      0, 0 },
	{ 0x1E00, 0x1E00, T_1E00 },
	{ 0x1EF9,      0, 0 },
	{ 0x1F00, 0x1F00, T_1F00 },
	{ 0x1FFC,      0, 0 },
	{ 0xFF21, 0xFF21, T_FF21 },
	{ 0xFF5A,      0, 0 },
};


/*----------------------------------------------------------------------
 *  Unicode lower case, returns the canonical unicode character.
 *  
 *----------------------------------------------------------------------
 */
unsigned int u_lcna(unsigned int unicode_value) {

    m_entry *row = 1 + master_table;
    int i=0;
    while (unicode_value > row->begin ) { ++row; }
    --row;
    unicode_value -= row->subtract;
    if (0 != row->conv_table) {
	unicode_value = row->conv_table[unicode_value];
    }
    return unicode_value;
}


/*----------------------------------------------------------------------+
 *  buff should be at least 7 characters to be really safe.		|
 *  Returns the number of bytes in the result, 0 for error.		|
 *----------------------------------------------------------------------+
 */
unsigned u2utf8(unsigned int unicode, unsigned char *buff)
{
  unsigned char *bf = buff;

  if (unicode < 0x80) {
    *bf++ = unicode;
    *bf = '\0';
    return 1;
  } else if (unicode < 0x800) {
    *bf++ = (0xC0 | unicode>>6);
    *bf++ = (0x80 | unicode & 0x3F);
    *bf = '\0';
    return 2;
  } else if (unicode < 0x10000) {
    *bf++ = (0xE0 | unicode>>12);
    *bf++ = (0x80 | unicode>>6 & 0x3F);
    *bf++ = (0x80 | unicode & 0x3F);
    *bf = '\0';
    return 3;
  } else if (unicode < 0x200000) {
    *bf++ = (0xF0 | unicode>>18);
    *bf++ = (0x80 | unicode>>12 & 0x3F);
    *bf++ = (0x80 | unicode>>6 & 0x3F);
    *bf++ = (0x80 | unicode & 0x3F);
    *bf = '\0';
    return 4;
  } else {
    fprintf(stderr,"Unicode value too big: %d\n",unicode);
    *bf = '\0';
    return 0;
  }
}


/*----------------------------------------------------------------------
 *	Returns the unicode value of the utf8 char that is being	
 *  pointed to, and increments the pointer to the next utf-8 character.  
 *----------------------------------------------------------------------
 */
unsigned utf82u(unsigned char **yy) {

    if (**yy < 0x80) {
        return *(*yy)++;
    } else if (**yy >= 0x80 && **yy < 0xC0) {
        fprintf( stderr, "bad utf8 beginning: %02i\n", **yy);
    } else {
        unsigned out = *(*yy)++;
	unsigned bytes = 0;
	unsigned leadmask = 0x80;

	while (leadmask & out) { 
	    ++bytes; 
	    out &= (leadmask - 1);	/* if out & 80, out &= 7f ... */
	    leadmask >>=1;
	}
	if (bytes < 2) {
	    fprintf( stderr, "bad utf8 start: %02i, %02i", yy[-1], *yy);
	    return 0;
	}
	while (--bytes) {
	    out <<= 6;
	    out |= (*(*yy)++ & 0x3f);
	}
	return out;
    }
}

/*----------------------------------------------------------------------
 * UTF-8 multi-byte characters begin with a character with the top two bits 
 * set, all following characters have the top two bits set to "10" (base 2). 
 */
int
IsUTF8_Start_Char(unsigned char c) {

  /* top two bits must be set */
  if ( (c & 0xC0) != 0xC0 )
    return FALSE;
  else {
    /*
     * bitmask   UTF-8 char format    # characters
     *  0xC0        110XXXXX               2
     *  0xE0        1110XXXX               3
     *  0xF0        11110XXX               4
     *  0xF8        111110XX               5
     *  0xFC        1111110X               6
     */

    if ((c & 0xE0) == 0xC0)
      return TRUE;
    else if ((c & 0xF0) == 0xE0)
      return TRUE;
    else if ((c & 0xF8) == 0xF0)
      return TRUE;
    else if ((c & 0xFC) == 0xF8)
      return TRUE;
    else if ((c & 0xFE) == 0xFC)
      return TRUE;
    else {
      /* this is not a real UTF-8 start character */
      return FALSE;
    }
  }
}

/*----------------------------------------------------------------------
 * Test to see if this is a UTF-8 continuation character.
 */
int
IsUTF8_Continuation_Char(unsigned char c) {

    /* top two bits are "10" */
    if ( (c & 0xC0) == 0x80 )
        return TRUE;
    else 
        return FALSE;
  
}

/*----------------------------------------------------------------------
 * Convert an array of characters in UTF-8 into Unicode.
 */
unsigned int utf8toi(unsigned char *s) {

  unsigned int v = 0;   /* Unicode value of UTF-8 encoded string */
  int i;                /* counter */
  int t;                /* bit mask for first UTF-8 character */
  int bytes;            /* the number of bytes we expect */

  if (s == NULL)
    return 0;

  /*
   * first check to see that this might be a UTF-8 character string,
   * it must begin with 0xC0
   */
  if ((s[0] & 0xC0) == 0xC0 ) {

    /*
     * hex    binary  #bytes
     * 0xC0  11000000   2
     * 0xE0  11100000   3
     * 0xF0  11110000   4
     * 0xF8  11111000   5
     * 0xFC  11111100   6
     */

    if ( (s[0] & 0xE0) == 0xC0) {
      t = 0xC0;
      bytes = 2;
    }
    else if ( (s[0] & 0xF0) == 0xE0) {
      t = 0xE0;
      bytes = 3;
    }
    else if ( (s[0] & 0xF8) == 0xF0) {
      t = 0xF0;
      bytes = 4;
    }
    else if ( (s[0] & 0xFC) == 0xF8) {
      t = 0xF8;
      bytes = 5;
    }
    else if ( (s[0] & 0xFE) == 0xFC) {
      t = 0xFC;
      bytes = 6;
    }
    else {
      /* this is not a real UTF-8 character */
      return s[0];
    }

    v = s[0] - t;
    i = 1;
    while (s[i] && (i < bytes) && IsUTF8_Continuation_Char(s[i])) {
      v = (v << 6) + (s[i] & 0x3F);
      i++;
    }
    return v;
  }
  else {
      /* not even a UTF-8 character, return ascii */
      return s[0];
  }

}


/*----------------------------------------------------------------------
 * Test an array of characters to see if any high bits are set
 *----------------------------------------------------------------------
 */
int asciiClean(unsigned char *s) {

    if (s == NULL)
	return TRUE;

    while (*s && !(*s++ & 0x80));

    if (*s)
	return FALSE;
    else
	return TRUE;

}


/*----------------------------------------------------------------------
 * Test an array of characters to see if it is valid UTF-8
 *----------------------------------------------------------------------
 */
int validUTF8(unsigned char *s) {

  unsigned int v = 0;   /* Unicode value of UTF-8 encoded string */
  int i =0;             /* counter */
  int bytes;            /* the number of bytes we expect */
  int len;

  if (s == NULL)
    return TRUE;

  len = strlen((char *)s);
  while (s[i] && i < len) {
      /*
       * first check to see that this might be a UTF-8 character string,
       * it must begin with 0xC0
       */
      if ((s[i] & 0xC0) == 0xC0 ) {

	  /*
	   * hex    binary  #bytes
	   * 0xC0  11000000   2
	   * 0xE0  11100000   3
	   * 0xF0  11110000   4
	   * 0xF8  11111000   5
	   * 0xFC  11111100   6
	   */
	  
	  if ( (s[i] & 0xE0) == 0xC0) {
	      bytes = 2;
	  }
	  else if ( (s[i] & 0xF0) == 0xE0) {
	      bytes = 3;
	  }
	  else if ( (s[i] & 0xF8) == 0xF0) {
	      bytes = 4;
	  }
	  else if ( (s[i] & 0xFC) == 0xF8) {
	      bytes = 5;
	  }
	  else if ( (s[i] & 0xFE) == 0xFC) {
	      bytes = 6;
	  }
	  else {
	      /* this is not a real UTF-8 character */
	      return FALSE;
	  }
	  int j = 1;
	  while (s[i+j] && (i+j < len) && (j < bytes) && IsUTF8_Continuation_Char(s[i+j])) {
	      j++;
	  }
	  if ( j < bytes ) {
	      /* no enough continuation characters */
	      return FALSE;
	  }
	  i += j;
      }
      else if (s[i] & 0x80) {
	  /* high bit set, but not UTF-8 */
	  return FALSE;
      }
      else {
	  /* no high bit set */
	  i++;
      }

  }

  /* everything is UTF-8 complient */
  return TRUE;

}

/*----------------------------------------------------------------------
 * Test to see if this UTF-8 character is in the CJK (japanese, korean, 
 * chinese) character set range.
 */
int
IsUTF8_CJK_Char(unsigned char *s) {

    /* Unicode CJK range + extended = [0x2F00,0xFFFF] */

    unsigned int v = 0;

    if (s && IsUTF8_Start_Char(s[0])) {
        v = utf8toi(s);
	if (( 0x2F00 <= v) && ( v <= 0xFFFF))
	    return TRUE;
    }

    /* not even a UTF-8 character */
    return FALSE;
}

